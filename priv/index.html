<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Websocket client</title>
</head>

<body>

<header>
	<h1>Websocket client</h1>
	<div id="status"></div>
</header>

<nav>
	<div id="connecting">
    <input type='text' id="uuid" value=""></input><br />
		<input type='text' id="server" value=""></input>
		<button type="button" onclick="toggle_connection()">connection</button>
	</div>

	<div id="connected">
		<input type='text' id="pin" value=""></input>
		<button type="button" onclick="create_game();">Create Game</button>
		<button type="button" onclick="join_game();">Join Game</button>
	</div>
</nav>

<main id="content">
	<button id="clear" onclick="clearScreen()" >Clear text</button>
	<div id="output"></div>
</main>

<script type="module">
  import { v4 as uuidv4 } from 'https://jspm.dev/uuid';
  var uuid = document.getElementById("uuid");
  uuid.value = uuidv4();
</script>

<script type="text/javascript">

var websocket;
var server = document.getElementById("server");
var pin = document.getElementById("pin");
var connecting = document.getElementById("connecting");
var connected = document.getElementById("connected");
var content = document.getElementById("content");
var output = document.getElementById("output");
var uuid = document.getElementById("uuid");

server.value = "ws://" + window.location.host + "/websocket";

function connect()
{
	wsHost = server.value + "?uuid=" + uuid.value + "&nickname=烙餅";
	websocket = new WebSocket(wsHost);
	showScreen('<b>Connecting to: ' +  wsHost + '</b>');
	websocket.onopen = function(evt) { onOpen(evt) };
	websocket.onclose = function(evt) { onClose(evt) };
	websocket.onmessage = function(evt) { onMessage(evt) };
	websocket.onerror = function(evt) { onError(evt) };
};

function disconnect() {
	websocket.close();
};

function toggle_connection(){
	if (websocket && websocket.readyState == websocket.OPEN) {
		disconnect();
	} else {
		connect();
	};
};

function create_game() {
	if (websocket.readyState == websocket.OPEN) {
		websocket.send(JSON.stringify({action: 'create_game'}));
	} else {
		showScreen('websocket is not connected');
	};
};

function join_game() {
	if (websocket.readyState == websocket.OPEN) {
		websocket.send(JSON.stringify({action: 'join_game', data: pin.value}));
	} else {
		showScreen('websocket is not connected');
	};
};

function onOpen(evt) {
	showScreen('<span style="color: green;">CONNECTED </span>');
    let pin = function() {
      websocket.send("ping")
    }

    window.setInterval(pin, 1000);
};

function onClose(evt) {
	showScreen('<span style="color: red;">DISCONNECTED</span>');
};

function onMessage(evt) {
  let obj = JSON.parse(evt.data);
  console.log(obj);
	showScreen('<span style="color: blue;">RESPONSE: ' + JSON.stringify(obj) + '</span>');
};

function onError(evt) {
	showScreen('<span style="color: red;">ERROR: ' + evt.data + '</span>');
};

function showScreen(html) {
	var el = document.createElement("p");
	el.innerHTML = html;
	output.insertBefore(el, output.firstChild);
};

function clearScreen() {
	output.innerHTML = "";
};

</script>
</body>
</html> 
